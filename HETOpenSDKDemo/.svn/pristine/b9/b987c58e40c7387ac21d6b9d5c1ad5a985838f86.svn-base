//
//  HETDeviceInfoViewController.m
//  HETOpenSDKDemo
//
//  Created by mr.cao on 16/7/12.
//  Copyright © 2016年 mr.cao. All rights reserved.
//

#import "HETDeviceInfoViewController.h"


#import "HETWIFIUpgradeViewController.h"

#import  <HETOpenSDK/HETOpenSDK.h>

@interface HETDeviceInfoViewController ()



@property (nonatomic,copy  ) NSString       * oldDeviceVersion;
@property (nonatomic,copy)   NSString       * bleBinUrl;         //delivery to upgrade VC , push version dictory is better method
@property (nonatomic)        NSInteger        deviceVersionId;



/**
 *  当升级的设备中有WiFi和蓝牙需要升级时，蓝牙的
 *  固件ID用bleDeviceVersionId字段表示
 */
@property (nonatomic)        NSInteger        bleDeviceVersionId;

@property (nonatomic,copy  ) NSString       * devNewVersion;


@property (nonatomic,strong) UIAlertView    * startUpGradeAler;



@end

@implementation HETDeviceInfoViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    
       UIButton *upgradeBtn = [UIButton buttonWithType:UIButtonTypeCustom];
       upgradeBtn.frame =  CGRectMake(self.view.bounds.size.width/2.0-150/2.0, 100, 150, 44);
       [upgradeBtn setTitle:@"设备升级" forState:UIControlStateNormal];
       [upgradeBtn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
       [upgradeBtn addTarget:self action:@selector(upgradeBtnAction) forControlEvents:UIControlEventTouchUpInside];
       upgradeBtn.backgroundColor=[self colorFromHexRGB:@"2E7BD3"];
       [self.view addSubview:upgradeBtn];
    
    
        UIButton *runDataBtn = [UIButton buttonWithType:UIButtonTypeCustom];
        runDataBtn.frame =  CGRectMake(self.view.bounds.size.width/2.0-150/2.0, 210, 150, 44);
        [runDataBtn setTitle:@"设备历史运行数据" forState:UIControlStateNormal];
        [runDataBtn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
        [runDataBtn addTarget:self action:@selector(runBtnAction) forControlEvents:UIControlEventTouchUpInside];
        runDataBtn.backgroundColor=[self colorFromHexRGB:@"2E7BD3"];
        [self.view addSubview:runDataBtn];
    
    
   
    
    
    
}
-(void)upgradeBtnAction
{
     NSString *deviceId=[self.deviceInformation objectForKey:@"deviceId"];
    HETDeviceUpgradeBusiness *upgradeBusiness=[[HETDeviceUpgradeBusiness alloc]init];
    [upgradeBusiness deviceUpgradeCheckWithDeviceId:deviceId success:^(id dictValue) {
        
        
        NSLog(@"%@",dictValue);
        if ([[dictValue allKeys] containsObject:@"newDeviceVersion"]) {
            self.oldDeviceVersion = dictValue[@"oldDeviceVersion"];
            self.devNewVersion = dictValue[@"newDeviceVersion"];
            self.bleBinUrl = dictValue[@"filePath"];
            self.deviceVersionId = [dictValue[@"deviceVersionId"] integerValue];
            self.bleDeviceVersionId = [dictValue[@"deviceBleFirmId"] integerValue];
            
        }else{
            self.oldDeviceVersion = dictValue[@"oldDeviceVersion"];
            self.devNewVersion = nil;
        }
        
        [self.startUpGradeAler show];
        
        
        
    } failure:^(NSError *error) {
        NSLog(@"获取硬件版本信息错误:%@",error);
    }];

    
    
}


-(void)runBtnAction
{
    HETDeviceRequestBusiness *request=[[HETDeviceRequestBusiness alloc]init];
    NSString *deviceId=[self.deviceInformation objectForKey:@"deviceId"];
    NSDate *senddate = [NSDate date];
    NSDateFormatter *dateformatter = [[NSDateFormatter alloc] init];
    [dateformatter setDateFormat:@"YYYY-MM-dd"];
    NSString *locationString = [dateformatter stringFromDate:senddate];
    NSLog(@"locationString:%@", locationString);
    
    NSDate *yesterday = [NSDate dateWithTimeIntervalSinceNow:-(24*60*60)];
    
    NSString *lastlocationString = [dateformatter stringFromDate:yesterday];
    NSLog(@"locationString:%@", lastlocationString);
    
    
    [request fetchDeviceRundataListWithDeviceId:deviceId startDate:lastlocationString endDate:nil pageRows:nil pageIndex:nil success:^(id responseObject) {
        
    } failure:^(NSError *error) {
        
    }];
    
}




- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}


#pragma mark   UIAlertViewDelegate
-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    if (buttonIndex == 0) {
        return ;
    }
    if (self.oldDeviceVersion && self.devNewVersion && ![self.devNewVersion isEqualToString:self.oldDeviceVersion]){
        if (self.deviceInformation) {
            NSInteger deviceTypeId = [[self.deviceInformation objectForKey:@"deviceTypeId"] intValue];
            HETWIFIUpgradeViewController * wifiUpgrade = [[HETWIFIUpgradeViewController alloc] init];
            wifiUpgrade.deviceId = [self.deviceInformation objectForKey:@"deviceId"];
            wifiUpgrade.versionType = self.devNewVersion;
            wifiUpgrade.deviceVersionId = self.deviceVersionId;
            [self.navigationController pushViewController:wifiUpgrade animated:YES];
        }
    }
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

-(UIAlertView *)startUpGradeAler{
    if (!_startUpGradeAler) {
        if (self.oldDeviceVersion && self.devNewVersion && ![self.devNewVersion isEqualToString:self.oldDeviceVersion]) {
            _startUpGradeAler = [[UIAlertView alloc] initWithTitle: @"升级固件" message:[NSString stringWithFormat:@"当前版本:%@\n最新版本:%@ \n 确认进行固件升级？",self.oldDeviceVersion,self.devNewVersion] delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"确认升级", nil];
        }else{
            _startUpGradeAler = [[UIAlertView alloc] initWithTitle:@"升级固件" message:@"当前已是最新版本!" delegate:self cancelButtonTitle:@"确认" otherButtonTitles:nil];
        }
    }
    return _startUpGradeAler;
}
@end
